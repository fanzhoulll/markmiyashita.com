# coding: utf-8
ROOT = File.expand_path('.')

require 'rubygems'
begin
  require 'colored'
rescue LoadError
  raise 'You must "gem install colored" to use terminal colors'
end

def die(s)
  puts(s.red)
  exit(1)
end

def sys(cmd)
  puts ("> "+cmd).blue
  system(cmd)
end

def format_title(title)
  title.gsub('-', '_').gsub(' ', '_').downcase + '.md'
end

def format_dir(title)
  title.gsub('-', '_').gsub(' ', '_').downcase
end

def format_title_with_directory(title)
  s = title.split('/')
  [format_dir(s[0]), format_title(title)]
end

desc "run the local server"
task :serve do
  sys("jekyll")
end

desc "generate a new post"
namespace :post do
  date = Time.now.strftime("%Y-%m-%d-")
  namespace :cs61a do
    task :note, [:title] do |t, args|
      title = format_title(args[:title])
      sys("cp #{ROOT}/_posts/templates/cs61a_note_template.md #{ROOT}/_posts/cs61a/notes/#{date + title}")
    end

    task :problem, [:title] do |t, args|
      title = format_title(args[:title])
      sys("cp #{ROOT}/_posts/templates/cs61a_problem_template.md #{ROOT}/_posts/cs61a/problems/#{date + title}")
    end
  end

  task :blog, [:title] do |t, args|
    title = format_title(args[:title])
    sys("cp #{ROOT}/_posts/templates/blog_template.md #{ROOT}/_posts/blog/#{date + title}")
  end

  namespace :rails do
    task :chapter, [:title] do |t, args|
      title = format_title(args[:title])
      sys("cp #{ROOT}/_posts/templates/web_dev_note_template.md #{ROOT}/_posts/web_dev/rails/#{date + title}")
    end
  end
end

task :note, [:title] do |t, args|
  title = format_title(args[:title])
  sys("touch #{ROOT}/_includes/cs61a/notes/#{title}")
end

task :problem, [:title] do |t, args|
  directory, title = format_title_with_directory(args[:title])
  sys("mkdir -p #{ROOT}/_includes/cs61a/problems/#{directory}")
  sys("touch #{ROOT}/_includes/cs61a/problems/#{title}")
end

task :default => :server